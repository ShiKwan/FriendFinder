<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Tables Page</title>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <!-- Chosen -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.5.1/chosen.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.5.1/chosen.jquery.min.js"></script>

</head>

<body>

    <div class="container">
        
        <div class="jumbotron">
            <h1 class="text-center">
                <span class="glyphicon glyphicon-fire"></span> Friend Finder</h1>
            <hr>
            <h2 class="text-center">Fill out the survey and leave the rest to us! We will find your best companion!</h2>
            <br>

            <div class="text-center">
                <a href="/view">
                    <button type="button" class="btn btn-lg btn-primary">
                        <span class="glyphicon glyphicon-list-alt"></span> View Friends</button>
                </a>
                <a href="/survey">
                    <button type="button" class="btn btn-lg btn-danger">
                        <span class="glyphicon glyphicon-credit-card"></span>Survey</button>
                </a>
            </div>
        </div>
        <div id="msgCenter" role="alert" class="alert text-center"></div>
        <div class="row">
            <div class="col-lg-12">
        
                <div class="survey-panel panel panel-default">
                    <div class="panel-heading">
                        <h4 class="panel-title">Survey</h4>
                    </div>
                    <div class="panel-body">
        
                        <form role="form">
        
                            <div class="form-group">
                                <label id="lblUserName" for="txtUserName">Name</label>
                                <input type="text" class="form-control" id="txtUserName">
                            </div>

                            <div class="form-group">
                                <label id="lblUserPhoto" for="txtUserPhoto">Photo</label>
                                <input type="text" class="form-control" id="txtUserPhoto">
                            </div>
                            
                            <div class="form-group">
                                <label id="lblSex">Sex</label><br />
                                <select class="ddl-survey sex">
                                    <option></option>
                                    <option value="male">male</option>
                                    <option value="female">female</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label id="lblLookingFor">Looking for .. </label><br />
                                <select class="ddl-survey looking-for">
                                    <option></option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <h4>Question 1</h4>
                                <label id="lblQ1">Your mind is always buzzing with unexplored ideas and plans</label>
                                <!-- Single button -->
                                <br />
                                <select data-placeholder="Select a value..." class="ddl-survey q1">
                                    <option></option>
                                    <option value="1">
                                        1 (Strongly Disagree)
                                    </option>  
                                    <option value="2">
                                        2
                                    </option>
                                    <option value="3">
                                        3
                                    </option>
                                    <option value="4">
                                        4
                                    </option>
                                    <option value="5">
                                        5 (Strongly Agree)
                                    </option>
                                </select>
                            </div>

                            <div class="form-group">
                                <h4>Question 2</h4>
                                <label id="lblQ2">Generally speaking, you rely more on your experience than your imagination.</label>
                                <br />
                                <select data-placeholder="Select a value..." class="ddl-survey q2">
                                    <option></option>
                                    <option value="1">
                                        1 (Strongly Disagree)
                                    </option>
                                    <option value="2">
                                        2
                                    </option>
                                    <option value="3">
                                        3
                                    </option>
                                    <option value="4">
                                        4
                                    </option>
                                    <option value="5">
                                        5 (Strongly Agree)
                                    </option>
                                </select>
                            </div>

                            <div class="form-group">
                                <h4>Question 3</h4>
                                <label id="lblQ3">You find it easy to stay relaxed and focused even when there is some pressure.</label>
                                <br />
                                <select data-placeholder="Select a value..." class="ddl-survey q3">
                                    <option></option>
                                    <option value="1">
                                        1 (Strongly Disagree)
                                    </option>
                                    <option value="2">
                                        2
                                    </option>
                                    <option value="3">
                                        3
                                    </option>
                                    <option value="4">
                                        4
                                    </option>
                                    <option value="5">
                                        5 (Strongly Agree)
                                    </option>
                                </select>
                            </div>

                            <div class="form-group">
                                <h4>Question 4</h4>
                                <label id="lblQ4">You rarely do something just out of sheer curiosity.</label>
                                <br />
                                <select data-placeholder="Select a value..." class="ddl-survey q4">
                                    <option></option>
                                    <option value="1">
                                        1 (Strongly Disagree)
                                    </option>
                                    <option value="2">
                                        2
                                    </option>
                                    <option value="3">
                                        3
                                    </option>
                                    <option value="4">
                                        4
                                    </option>
                                    <option value="5">
                                        5 (Strongly Agree)
                                    </option>
                                </select>
                            </div>

                            <div class="form-group">
                                <h4>Question 5</h4>
                                <label id="lblQ5">People can rarely upset you.</label>
                                <br />
                                <select data-placeholder="Select a value..." class="ddl-survey q5">
                                    <option></option>
                                    <option value="1">
                                        1 (Strongly Disagree)
                                    </option>
                                    <option value="2">
                                        2
                                    </option>
                                    <option value="3">
                                        3
                                    </option>
                                    <option value="4">
                                        4
                                    </option>
                                    <option value="5">
                                        5 (Strongly Agree)
                                    </option>
                                </select>
                            </div>

                            <div class="form-group">
                                <h4>Question 6</h4>
                                <label id="lblQ6">It is often difficult for you to relate to other people’s feelings</label>
                                <br />
                                <select data-placeholder="Select a value..." class="ddl-survey q6">
                                    <option></option>
                                    <option value="1">
                                        1 (Strongly Disagree)
                                    </option>
                                    <option value="2">
                                        2
                                    </option>
                                    <option value="3">
                                        3
                                    </option>
                                    <option value="4">
                                        4
                                    </option>
                                    <option value="5">
                                        5 (Strongly Agree)
                                    </option>
                                </select>
                            </div>

                            <div class="form-group">
                                <h4>Question 7</h4>
                                <label id="lblQ7">In a discussion, truth should be more important than people’s sensitivities.</label>
                                <br />
                                <select data-placeholder="Select a value..." class="ddl-survey q7">
                                    <option></option>
                                    <option value="1">
                                        1 (Strongly Disagree)
                                    </option>
                                    <option value="2">
                                        2
                                    </option>
                                    <option value="3">
                                        3
                                    </option>
                                    <option value="4">
                                        4
                                    </option>
                                    <option value="5">
                                        5 (Strongly Agree)
                                    </option>
                                </select>
                            </div>

                            <div class="form-group">
                                <h4>Question 8</h4>
                                <label id="lblQ8">You rarely get carried away by fantasies and ideas.</label>
                                <br />
                                <select data-placeholder="Select a value..." class="ddl-survey q8">
                                    <option></option>
                                    <option value="1">
                                        1 (Strongly Disagree)
                                    </option>
                                    <option value="2">
                                        2
                                    </option>
                                    <option value="3">
                                        3
                                    </option>
                                    <option value="4">
                                        4
                                    </option>
                                    <option value="5">
                                        5 (Strongly Agree)
                                    </option>
                                </select>
                            </div>

                            <div class="form-group">
                                <h4>Question 9</h4>
                                <label id="lblQ9">You think that everyone’s views should be respected regardless of whether they are supported by facts or not.</label>
                                <br />
                                <select data-placeholder="Select a value..." class="ddl-survey q9">
                                    <option></option>
                                    <option value="1">
                                        1 (Strongly Disagree)
                                    </option>
                                    <option value="2">
                                        2
                                    </option>
                                    <option value="3">
                                        3
                                    </option>
                                    <option value="4">
                                        4
                                    </option>
                                    <option value="5">
                                        5 (Strongly Agree)
                                    </option>
                                </select>
                            </div>

                            <div class="form-group">
                                <h4>Question 10</h4>
                                <label id="lblQ10">You feel more energetic after spending time with a group of people.</label>
                                <br />
                                <select data-placeholder="Select a value..." class="ddl-survey q10">
                                    <option></option>
                                    <option value="1">
                                        1 (Strongly Disagree)
                                    </option>
                                    <option value="2">
                                        2
                                    </option>
                                    <option value="3">
                                        3
                                    </option>
                                    <option value="4">
                                        4
                                    </option>
                                    <option value="5">
                                        5 (Strongly Agree)
                                    </option>
                                </select>
                            </div>        
                            <button type="submit"  class="btn btn-primary submit">Submit</button>
                        </form>
        
                    </div>
                </div>
                <div class="found-panel" style="display:none;">

                </div>
            </div>
        </div>
        <footer class="footer">
            <div class="container">
                <p>
                    <a href="/api/male">API Male Users</a> |
                    <a href="/api/female">API Female Users</a> |
                    <a href="https://github.com/ShiKwan/FriendFinder">GitHub Repo</a>
                </p>
            </div>
        </footer>

    </div>
    <style>
         .required:after { content:" *"; }
         .required {color: red;}
    </style>

    <script type="text/javascript">

        var maleArr = [], femaleArr= [];
        $.get("/api/male", function (data) {
            if(data){
                for(var i =0; i< data.length; i++){
                    maleArr.push(data[i]);
                }
            }
        });
        $.get("/api/female", function (data) {
            if(data){
                for (var i = 0; i < data.length; i++) {
                    femaleArr.push(data[i]);
                }
            }
        });
        
        console.log("male..");
        console.log(maleArr);
        console.log("female..");
        console.log(femaleArr);
        
        $(".ddl-survey").chosen({width: "95%"});
        function setErrorMsg(msgCenter){
            msgCenter.addClass("alert-danger");
            msgCenter.html("Please fill out the highlighted area")
        }
        function validateTextbox(lbl, txt, msgCenter){

            if(!txt.val()){
                lbl.addClass("required");
                setErrorMsg(msgCenter);
                return false;
            }else{
                return true;
            }

        }
        function validateDDL(lbl, ddl, msgCenter){
            if (!ddl.chosen().val()) {
                lbl.addClass("required");
                setErrorMsg(msgCenter);
                return false;
            }else{
                return true;
            }
        }

        function resetValidation(){
            $("#msgCenter").removeClass("alert-danger");
            $("#msgCenter").empty();
            $(".form-group label").removeClass("required");
        }

        function validateSurvey(msgCenter){
            var validated = true;
            msgCenter.removeClass("alert-danger")
            if(validated){
                console.log("validating username...")
                validated = validateTextbox($("#lblUserName"), $("#txtUserName"), msgCenter);
                console.log("finished, and validate is.. " + validated)
            }else{
                return validated
            }
            if(validated){
               validated = validateTextbox($("#lblUserPhoto"), $("#txtUserPhoto"), msgCenter)
               console.log("finished validating photo, and validate is.. " + validated)
            } else {
                return validated
            }
            if (validated) {
                validated = validateDDL($("#lblSex"), $(".sex"), msgCenter)
                console.log("finished validating sex, and validate is.. " + validated)
            } else {
                return validated
            }
            if (validated) {
                validated = validateDDL($("#lblLookingFor"), $(".looking-for"), msgCenter)
                console.log("finished validating looking for, and validate is.. " + validated)
            } else {
                return validated
            }
            if(validated){
                validated = validateDDL($("#lblQ1"), $(".q1"), msgCenter)
                console.log("finished validating q1, and validate is.. " + validated)
            } else {
                return validated
            }
            if (validated) {
                validated = validateDDL($("#lblQ2"), $(".q2"), msgCenter)
                console.log("finished validating q1, and validate is.. " + validated)
            } else {
                return validated
            }
            if (validated) {
                validated = validateDDL($("#lblQ3"), $(".q3"), msgCenter)
                console.log("finished validating q1, and validate is.. " + validated)
            } else {
                return validated
            }
            if (validated) {
                validated = validateDDL($("#lblQ4"), $(".q4"), msgCenter)
                console.log("finished validating q1, and validate is.. " + validated)
            } else {
                return validated
            }
            if (validated) {
                validated = validateDDL($("#lblQ5"), $(".q5"), msgCenter)
                console.log("finished validating q1, and validate is.. " + validated)
            } else {
                return validated
            }
            if (validated) {
                validated = validateDDL($("#lblQ6"), $(".q6"), msgCenter)
                console.log("finished validating q1, and validate is.. " + validated)
            } else {
                return validated
            }
            if (validated) {
                validated = validateDDL($("#lblQ7"), $(".q7"), msgCenter)
                console.log("finished validating q1, and validate is.. " + validated)
            } else {
                return validated
            }
            if (validated) {
                validated = validateDDL($("#lblQ8"), $(".q8"), msgCenter)
                console.log("finished validating q1, and validate is.. " + validated)
            } else {
                return validated
            }
            if (validated) {
                validated = validateDDL($("#lblQ9"), $(".q9"), msgCenter)
                console.log("finished validating q1, and validate is.. " + validated)
            } else {
                return validated
            }
            if (validated) {
                validated = validateDDL($("#lblQ10"), $(".q10"), msgCenter)
                console.log("finished validating q1, and validate is.. " + validated)
            } else {
                return validated
            }
            return validated
        }
        
        $(".submit").click(function () {
            console.log("test");
            event.preventDefault();

            $("#msgCenter").hide();
            $("#msgCenter").empty();
            var validated = true;
            resetValidation();
            validated = validateSurvey($("#msgCenter"));
            //console.log(validated);

             //validated = validateTextbox($("lblUserName"),$("txtUserName"), $("#msgCenter"));
            
            /* if(!validated){
                $("#msgCenter").show();
            } */
            
            if(validated){
                var newSurvey = {
                    name: $("#txtUserName").val().trim(),
                    shownName : $("#txtUserName").val().trim().replace(/\s+/g, "").toLowerCase(),
                    pic: $("#txtUserPhoto").val().trim(),
                    sex : $(".sex").chosen().val(),
                    lookingFor : $(".looking-for").chosen().val(),
                    q1 : $(".q1").chosen().val(),
                    q2 : $(".q2").chosen().val(),
                    q3 : $(".q3").chosen().val(),
                    q4 : $(".q4").chosen().val(),
                    q5 : $(".q5").chosen().val(),
                    q6 : $(".q6").chosen().val(),
                    q7 : $(".q7").chosen().val(),
                    q8 : $(".q8").chosen().val(),
                    q9 : $(".q9").chosen().val(),
                    q10 : $(".q10").chosen().val()};
                
                console.log(newSurvey);

                if(newSurvey.sex === "male"){
                    console.log("adding user to male pool");
                    $.post("/api/addMale", newSurvey).then(function(data){
                        console.log(data);
                        alert("added users to male section, and we are looking for your best companion...");
                    })
                }else{
                    console.log("adding user to female pool");
                    $.post("/api/addFemale", newSurvey).then(function(data){
                        console.log(data);
                        alert("added users to female section, and we are looking for your best companion...");
                    })
                }
                var closestFriend;
                var diff = 100;

                function findDifference(lib, current){
                    for (var i = 0; i < lib.length; i++) {
                        var currentDiff = 0;
                        currentDiff = Math.abs(parseInt(lib[i].q1) - parseInt(current.q1));
                        currentDiff += Math.abs(parseInt(lib[i].q2) - parseInt(current.q2));
                        currentDiff += Math.abs(parseInt(lib[i].q3) - parseInt(current.q3));
                        currentDiff += Math.abs(parseInt(lib[i].q4) - parseInt(current.q4));
                        currentDiff += Math.abs(parseInt(lib[i].q5) - parseInt(current.q5));
                        currentDiff += Math.abs(parseInt(lib[i].q6) - parseInt(current.q6));
                        currentDiff += Math.abs(parseInt(lib[i].q7) - parseInt(current.q7));
                        currentDiff += Math.abs(parseInt(lib[i].q8) - parseInt(current.q8));
                        currentDiff += Math.abs(parseInt(lib[i].q9) - parseInt(current.q9));
                        currentDiff += Math.abs(parseInt(lib[i].q10) - parseInt(current.q10));
                        if (currentDiff <= diff) {
                            console.log("current item is " + currentDiff + ", and previous item is " + diff)
                            console.log("this guy is better than the one before")
                            diff = currentDiff;
                            closestFriend = lib[i];
                        } else {
                            console.log("this guy is no good, next~");
                        }
                    }
                }
                if(newSurvey.lookingFor === "male"){
                    findDifference(maleArr, newSurvey);
                    
                }else{
                    findDifference(femaleArr, newSurvey);
                }
                $(".survey-panel").slideUp();
                $(".found-panel").slideDown();
                console.log("Found your match!");
                console.log(closestFriend);
                populateClosestFriend(closestFriend);
            }else{
                $("#msgCenter").show();
            }
        })

        function populateClosestFriend(person){
            $(".found-panel").show();
             var div = $("<div>");
            div.addClass("panel").addClass("panel-default")
            var divBody = $("<div>");
            divBody.addClass("panel-body")
            var row = $("<div>");
            row.addClass("row");
            var left = $("<div>");
            var right = $("<div>");
            left.addClass("col-md-4");
            right.addClass("col-md-8");
            var thumbHolder = $("<a>");
            thumbHolder.addClass("thumbnail");
            var img = $("<img>");
            var name = $("<h2>");
            var profile = $("<span>");
            var button = $("<button class='btn btn-lg btn-primary' style='float: right; margin-top: 50px'>");
            var glyHolder = $("<span>");
            var hypEmail = $("<a>");
            hypEmail.attr("href", "mailto:" + person.email);
            glyHolder.addClass("glyphicon").addClass("glyphicon-envelope");
            //button.append(glyHolder);
            button
            button.html(" Contact me").prepend(glyHolder);
            hypEmail.append(button);
            img.attr("src", person.pic);
            img.addClass("thumbnail");
            name.html(person.name);
            profile.html(person.profile);

            left.append(thumbHolder.append(img))
            right.append(name).append(profile).append(hypEmail);
            row.append(left).append(right);
            divBody.append(row);
            div.append(divBody);
            $(".found-panel").append(div);
        }

    </script>


</body>

</html>